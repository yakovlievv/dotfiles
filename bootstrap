#!/usr/bin/env zsh
set -euo pipefail

# --- SETUP ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No color

log()   { echo -e "${GREEN}==>${NC} $1"; }
warn()  { echo -e "${YELLOW}⚠${NC}  $1"; }
error() { echo -e "${RED}✖${NC}  $1" >&2; exit 1; }

# --- DETECT OS ---
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ -f /etc/arch-release ]]; then
    OS="arch"
elif [[ -f /etc/debian_version ]]; then
    OS="debian"
else
    error "Unsupported OS: $OSTYPE"
fi

log "Detected OS: $OS"

# --- INSTALL GIT (minimum requirement) ---
if [[ "$OS" == "macos" ]]; then
    if ! command -v git &>/dev/null; then
        xcode-select --install || true
    fi
elif [[ "$OS" == "arch" ]]; then
    sudo pacman -Sy --needed --noconfirm git curl
elif [[ "$OS" == "debian" ]]; then
    sudo apt update -y && sudo apt install -y git curl
fi

# --- CLONE DOTFILES ---
DOTFILES="$HOME/dotfiles"
if [[ -d "$DOTFILES" ]]; then
    warn "Dotfiles directory already exists. Pulling latest changes..."
    git -C "$DOTFILES" pull --recurse-submodules
else
    log "Cloning dotfiles repository..."
    git clone --recursive git@github.com:yakovlievv/dotfiles "$DOTFILES"
fi

# --- INSTALL DEPENDENCIES ---
if [[ "$OS" == "macos" ]]; then
    if ! command -v brew &>/dev/null; then
        warn "Homebrew not found. Installing for macOS..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        log "Homebrew installed successfully."
    else
        log "Homebrew already installed."
    fi
    brew install zsh-autosuggestions zsh-syntax-highlighting git less fzf ripgrep fd tmux neovim bat bat-extras wget

elif [[ "$OS" == "arch" ]]; then
    log "Installing packages via pacman..."
    sudo pacman -Sy --needed --noconfirm git zsh fzf ripgrep fd bat tmux neovim wget less

elif [[ "$OS" == "debian" ]]; then
    log "Installing packages via apt..."
    sudo apt update -y && sudo apt install -y git zsh fzf ripgrep fd-find bat tmux neovim wget less
fi

# --- BUILD BAT CACHE ---
if command -v bat &>/dev/null; then
    log "Building bat cache..."
    bat cache --build
else
    warn "bat not found, skipping cache build."
fi

# --- INSTALL NVM + NODE ---
if ! command -v nvm &>/dev/null; then
    log "Installing nvm..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
fi

log "Installing Node.js 24..."
nvm install 24

# --- INSTALL TPM ---
TPM_PATH="${XDG_CONFIG_HOME:-$HOME/.config}/tmux/plugins/tpm"
if [[ ! -d "$TPM_PATH" ]]; then
    log "Cloning TPM..."
    git clone --depth=1 https://github.com/tmux-plugins/tpm.git "$TPM_PATH"
else
    log "TPM already installed."
fi

log "✅ Bootstrap complete!"
